exec kogen build kogen.cue
cmp stdout golden.yaml

-- kogen.cue --
import "encoding/yaml"

kogen: main: {
	apiVersion: "kogen.internal/v1alpha1"
	kind:       "Cog"
	spec: resource: ["deployment.yaml"]
	spec: kustomize: patches: [{
		patch: yaml.Marshal({
			apiVersion: "apps/v1"
			kind:       "Deployment"
			metadata: name: "nginx"
			spec: template: spec: containers: [{
				name: "nginx"
				resources: limits: memory: "256Mi"
			}]
		})
	}]
}

-- deployment.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
        env:
        - name: EXISTING_VAR
          value: "existing"

-- golden.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx
  name: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - env:
        - name: EXISTING_VAR
          value: existing
        image: nginx:1.14.2
        name: nginx
        ports:
        - containerPort: 80
        resources:
          limits:
            memory: 256Mi
